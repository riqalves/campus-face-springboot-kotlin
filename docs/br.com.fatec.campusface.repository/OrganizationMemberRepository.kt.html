<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OrganizationMemberRepository.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">campusface</a> &gt; <a href="index.source.html" class="el_package">br.com.fatec.campusface.repository</a> &gt; <span class="el_source">OrganizationMemberRepository.kt</span></div><h1>OrganizationMemberRepository.kt</h1><pre class="source lang-java linenums">package br.com.fatec.campusface.repository

import br.com.fatec.campusface.models.MemberStatus
import br.com.fatec.campusface.models.OrganizationMember
import br.com.fatec.campusface.models.Role
import com.google.cloud.firestore.Firestore
import org.springframework.stereotype.Repository

<span class="fc" id="L9">@Repository</span>
<span class="fc" id="L10">class OrganizationMemberRepository(private val firestore: Firestore) {</span>

<span class="fc" id="L12">    private val collection = firestore.collection(&quot;organizationMembers&quot;)</span>

    fun save(member: OrganizationMember): OrganizationMember {
<span class="nc bnc" id="L15" title="All 8 branches missed.">        if (member.userId.isEmpty() || member.organizationId.isEmpty()) {</span>
<span class="nc" id="L16">            throw IllegalArgumentException(&quot;O ID do usuário e da organização não podem ser vazios&quot;)</span>
        }

        // Se já tiver ID, atualiza. Se não, cria um novo documento.
<span class="nc bnc" id="L20" title="All 4 branches missed.">        val docRef = if (member.id.isNotEmpty()) collection.document(member.id) else collection.document()</span>
<span class="nc" id="L21">        val memberWithId = member.copy(id = docRef.id)</span>

        // Usamos .set() para criar ou sobrescrever
<span class="nc" id="L24">        docRef.set(memberWithId).get()</span>

<span class="nc" id="L26">        return memberWithId</span>
    }

    fun findById(id: String): OrganizationMember? {
<span class="nc" id="L30">        val document = collection.document(id).get().get()</span>
<span class="nc bnc" id="L31" title="All 2 branches missed.">        return if (document.exists()) {</span>
<span class="nc bnc" id="L32" title="All 2 branches missed.">            document.toObject(OrganizationMember::class.java)?.copy(id = document.id)</span>
        } else {
<span class="nc" id="L34">            null</span>
        }
    }

    /**
     * Busca o vínculo específico de um usuário com uma organização.
     * Essencial para verificar permissões (ex: &quot;Este usuário é ADMIN desta org?&quot;).
     */
    fun findByUserIdAndOrganizationId(userId: String, organizationId: String): OrganizationMember? {
<span class="nc" id="L43">        val snapshot = collection</span>
<span class="nc" id="L44">            .whereEqualTo(&quot;userId&quot;, userId)</span>
<span class="nc" id="L45">            .whereEqualTo(&quot;organizationId&quot;, organizationId)</span>
<span class="nc" id="L46">            .limit(1)</span>
<span class="nc" id="L47">            .get().get()</span>

<span class="nc bnc" id="L49" title="All 4 branches missed.">        return snapshot.documents.firstOrNull()?.toObject(OrganizationMember::class.java)?.copy(id = snapshot.documents.first().id)</span>
    }

    /**
     * Retorna todas as organizações das quais o usuário faz parte.
     */
    fun findAllByUserId(userId: String): List&lt;OrganizationMember&gt; {
<span class="nc" id="L56">        val snapshot = collection</span>
<span class="nc" id="L57">            .whereEqualTo(&quot;userId&quot;, userId)</span>
<span class="nc" id="L58">            .get()</span>
<span class="nc" id="L59">            .get()</span>
<span class="nc" id="L60">        return snapshot.documents.mapNotNull { doc -&gt;</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">            doc.toObject(OrganizationMember::class.java)?.copy(id = doc.id)</span>
        }
    }

    /**
     * Retorna todos os membros de uma organização.
     */
    fun findAllByOrganizationId(organizationId: String): List&lt;OrganizationMember&gt; {
<span class="nc" id="L69">        val snapshot = collection</span>
<span class="nc" id="L70">            .whereEqualTo(&quot;organizationId&quot;, organizationId)</span>
<span class="nc" id="L71">            .get()</span>
<span class="nc" id="L72">            .get()</span>
<span class="nc" id="L73">        return snapshot.documents.mapNotNull { doc -&gt;</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">            doc.toObject(OrganizationMember::class.java)?.copy(id = doc.id)</span>
        }
    }

    /**
     * Busca membros de uma organização filtrando pelo cargo (Role).
     */
    fun findByOrganizationIdAndRole(organizationId: String, role: Role): List&lt;OrganizationMember&gt; {
<span class="nc" id="L82">        val snapshot = collection</span>
<span class="nc" id="L83">            .whereEqualTo(&quot;organizationId&quot;, organizationId)</span>
<span class="nc" id="L84">            .whereEqualTo(&quot;role&quot;, role.name)</span>
<span class="nc" id="L85">            .get()</span>
<span class="nc" id="L86">            .get()</span>

<span class="nc" id="L88">        return snapshot.documents.mapNotNull { doc -&gt;</span>
<span class="nc" id="L89">            doc.toObject(OrganizationMember::class.java).copy(id = doc.id)</span>
        }
    }

    /**
     * Atualiza apenas o campo 'faceImageId'.
     */
    fun updateFaceImageId(id: String, newFaceImagePublicId: String) {
<span class="nc" id="L97">        collection.document(id).update(&quot;faceImageId&quot;, newFaceImagePublicId).get()</span>
<span class="nc" id="L98">    }</span>

    /**
     * Atualiza o Status (ex: banir um membro ou aprovar um pendente).
     */
    fun updateStatus(id: String, status: MemberStatus) {
<span class="nc" id="L104">        collection.document(id).update(&quot;status&quot;, status.name).get()</span>
<span class="nc" id="L105">    }</span>

    /**
     * Atualiza a Role (ex: promover de MEMBER para VALIDATOR).
     */
    fun updateRole(id: String, role: Role) {
<span class="nc" id="L111">        collection.document(id).update(&quot;role&quot;, role.name).get()</span>
<span class="nc" id="L112">    }</span>

    fun delete(id: String) {
<span class="nc" id="L115">        collection.document(id).delete().get()</span>
<span class="nc" id="L116">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>
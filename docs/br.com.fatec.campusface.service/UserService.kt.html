<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserService.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">campusface</a> &gt; <a href="index.source.html" class="el_package">br.com.fatec.campusface.service</a> &gt; <span class="el_source">UserService.kt</span></div><h1>UserService.kt</h1><pre class="source lang-java linenums">package br.com.fatec.campusface.service

import br.com.fatec.campusface.dto.UserDTO
import br.com.fatec.campusface.dto.UserUpdateDTO
import br.com.fatec.campusface.models.User
import br.com.fatec.campusface.repository.UserRepository
import org.springframework.beans.factory.annotation.Value
import org.springframework.security.crypto.password.PasswordEncoder
import org.springframework.stereotype.Service
import org.springframework.web.multipart.MultipartFile

<span class="fc" id="L12">@Service</span>
<span class="fc" id="L13">class UserService(</span>
<span class="fc" id="L14">    private val userRepository: UserRepository,</span>
<span class="fc" id="L15">    private val passwordEncoder: PasswordEncoder,</span>
<span class="fc" id="L16">    private val cloudinaryService: CloudinaryService,</span>
<span class="fc" id="L17">    private val imageProcessingService: ImageProcessingService,</span>
) {

    @Value(&quot;\${default.organization.id}&quot;)
    private lateinit var defaultOrganizationId: String

    fun createUser(userData: User, imageFile: MultipartFile?): UserDTO {
        // validacao de email
<span class="nc bnc" id="L25" title="All 2 branches missed.">        if (userRepository.findByEmail(userData.email) != null) {</span>
<span class="nc" id="L26">            throw IllegalArgumentException(&quot;Email já cadastrado.&quot;)</span>
        }
        // Upload da imagem (se ouver)
        // o User generico pode ter foto, mas sera usada quando virar member em alguma org
<span class="nc" id="L30">        var imagePublicId: String? = null</span>
<span class="nc bnc" id="L31" title="All 2 branches missed.">        if (imageFile != null) {</span>
<span class="nc" id="L32">            val processedImageBytes = imageProcessingService.processImageForApi(imageFile)</span>
<span class="nc" id="L33">            val uploadResult = cloudinaryService.upload(processedImageBytes)</span>
<span class="nc bnc" id="L34" title="All 2 branches missed.">            imagePublicId = uploadResult[&quot;public_id&quot;]</span>
<span class="nc" id="L35">                ?: throw IllegalStateException(&quot;Public ID não foi retornado pelo Cloudinary.&quot;)</span>
        }

<span class="nc" id="L38">        val userToSave = userData.copy(</span>
<span class="nc" id="L39">            hashedPassword = passwordEncoder.encode(userData.hashedPassword),</span>
<span class="nc" id="L40">            faceImageId = imagePublicId</span>
        )
<span class="nc" id="L42">        val savedUser = userRepository.save(userToSave)</span>

<span class="nc" id="L44">        return savedUser.toDTO()</span>
    }

    fun updateProfileImage(userId:String,  imageFile: MultipartFile):UserDTO {
<span class="nc bnc" id="L48" title="All 2 branches missed.">        val user = userRepository.findById(userId)</span>
<span class="nc" id="L49">            ?: throw IllegalArgumentException(&quot;Usuario nao encontrado&quot;)</span>
<span class="nc" id="L50">        validateImage(imageFile)</span>

        //Se tiver foto antiga deleta do cloudinary
<span class="nc bnc" id="L53" title="All 2 branches missed.">        user.faceImageId?.let { cloudinaryService.delete(it) }</span>

<span class="nc" id="L55">        val processedImageBytes = imageProcessingService.processImageForApi(imageFile)</span>
<span class="nc" id="L56">        val uploadResult = cloudinaryService.upload(processedImageBytes)</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">        val newPublicId = uploadResult[&quot;public_id&quot;]</span>
<span class="nc" id="L58">            ?:throw IllegalStateException(&quot;Erro no upload da imagem&quot;)</span>

<span class="nc" id="L60">        val updatedUser = user.copy(faceImageId = newPublicId)</span>
<span class="nc" id="L61">        userRepository.save(updatedUser)</span>
<span class="nc" id="L62">        return updatedUser.toDTO()</span>
    }

    /**
     * Atualiza os dados cadastrais do usuário (Nome, Email, Senha, Documento).
     */
    fun updateUser(userId: String, data:  UserUpdateDTO): UserDTO {
<span class="nc bnc" id="L69" title="All 2 branches missed.">        val user = userRepository.findById(userId)</span>
<span class="nc" id="L70">            ?: throw IllegalArgumentException(&quot;Usuário não encontrado.&quot;)</span>

<span class="nc" id="L72">        println(&quot;DEBUG USERSERVICE - UPDATEUSER: $userId, $data&quot;)</span>
        // validação de Email Único (se estiver trocando)
<span class="nc bnc" id="L74" title="All 8 branches missed.">        if (!data.email.isNullOrBlank() &amp;&amp; data.email != user.email) {</span>
<span class="nc" id="L75">            val emailOwner = userRepository.findByEmail(data.email)</span>
<span class="nc bnc" id="L76" title="All 4 branches missed.">            if (emailOwner != null &amp;&amp; emailOwner.id != userId) {</span>
<span class="nc" id="L77">                throw IllegalArgumentException(&quot;Este e-mail já está em uso por outro usuário.&quot;)</span>
            }
        }


        // atualização dos campos Mantém o antigo se o novo for nulo
<span class="nc" id="L83">        val updatedUser = user.copy(</span>
<span class="nc bnc" id="L84" title="All 6 branches missed.">            fullName = if (!data.fullName.isNullOrBlank()) data.fullName else user.fullName,</span>
<span class="nc bnc" id="L85" title="All 6 branches missed.">            email = if (!data.email.isNullOrBlank()) data.email else user.email,</span>
<span class="nc bnc" id="L86" title="All 6 branches missed.">            document = if (!data.document.isNullOrBlank()) data.document else user.document,</span>

            // Só criptografa se a senha foi enviada
<span class="nc bnc" id="L89" title="All 6 branches missed.">            hashedPassword = if (!data.password.isNullOrBlank()) {</span>
<span class="nc" id="L90">                passwordEncoder.encode(data.password)</span>
            } else {
<span class="nc" id="L92">                user.hashedPassword</span>
            },

<span class="nc" id="L95">            updatedAt = java.time.Instant.now()</span>
        )

<span class="nc" id="L98">        userRepository.save(updatedUser)</span>

<span class="nc" id="L100">        return updatedUser.toDTO()</span>
    }



    fun listUsers(): List&lt;UserDTO&gt; =
<span class="nc" id="L106">        userRepository.findAll().map { user -&gt; user.toDTO() }</span>

    fun getUserByEmail(email: String): UserDTO? {
<span class="nc bnc" id="L109" title="All 2 branches missed.">        return userRepository.findByEmail(email)?.toDTO()</span>
    }

    fun getUserById(id: String): UserDTO? {
<span class="nc bnc" id="L113" title="All 2 branches missed.">        return userRepository.findById(id)?.toDTO()</span>
    }

    fun deleteUser(id: String): Boolean {
<span class="nc" id="L117">        val user = userRepository.findById(id)</span>
        // Se tiver foto, deleta do Cloudinary
<span class="nc bnc" id="L119" title="All 4 branches missed.">        user?.faceImageId?.let { cloudinaryService.delete(it) }</span>

<span class="nc" id="L121">        return userRepository.delete(id)</span>
    }

    fun validateEmail(email: String): Boolean {
<span class="nc" id="L125">        val emailRegex = &quot;^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+$&quot;.toRegex()</span>
<span class="nc" id="L126">        return emailRegex.matches(email)</span>
    }


    private fun User.toDTO(): UserDTO {
        // Gera URL temporária apenas se tiver imagem
<span class="nc bnc" id="L132" title="All 2 branches missed.">        val temporaryImageUrl = this.faceImageId?.let { publicId -&gt;</span>
<span class="nc" id="L133">            cloudinaryService.generateSignedUrl(publicId)</span>
        }
<span class="nc" id="L135">        return UserDTO.fromEntity(this, temporaryImageUrl)</span>
    }

    private fun validateImage(imageFile: MultipartFile) {
        // Validação de tipo de arquivo
<span class="nc" id="L140">        val allowedTypes = listOf(&quot;image/png&quot;, &quot;image/jpeg&quot;, &quot;image/jpg&quot;)</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">        if (imageFile.contentType !in allowedTypes) {</span>
<span class="nc" id="L142">            throw IllegalArgumentException(&quot;Formato de imagem inválido. Apenas PNG, JPG e JPEG são permitidos.&quot;)</span>
        }

        // Validação de tamanho
<span class="nc" id="L146">        val maxSizeInBytes = 10 * 1024 * 1024 // 10 MB</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (imageFile.size &gt; maxSizeInBytes) {</span>
<span class="nc" id="L148">            throw IllegalArgumentException(&quot;A imagem excede o tamanho máximo de 5MB.&quot;)</span>
        }
<span class="nc" id="L150">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>